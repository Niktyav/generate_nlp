# Домашнее задание 1. Разработка retrieval-based чат-бота.

Необходимо разработать чат-бот, используя подход retrieval-based.    
Бот должен вести диалог как определенный персонаж сериала, имитируя стиль и манеру конкретного персонажа сериала.   
Важно учесть особенности речи и темы, которые поднимает персонаж, его типичные реакции.   

Выбран ситком "Друзья"  
    «Друзья» (англ. Friends) — американский ситком, повествующий о жизни шестерых друзей. Признан одним из лучших комедийных сериалов в истории американского телевидения и стал одним из наиболее знаменитых проектов 1990-х годов. Сама постановка и творческая группа получили множество наград, в том числе шесть премий «Эмми» и премию «Золотой глобус».
В качестве персонажа выбран Чендлер
-- Че́ндлер. Чендлер родился в семье писательницы эротических романов Норы Тайлер Бинг и гомосексуала-трансвестита Чарльза Бинга. У Чендлера множество комплексов, от которых он отгораживается постоянными шутками. Работа Чендлера — анализ и реконфигурация данных, и в этой сфере он делает неплохую карьеру.

## 1. Цель проекта

Цель домашней работы – отработка навыков:
- Поиска и подготовки данных для обучения моделей.
- Фильтрации и разметки диалогов.
- Обучения моделей для retrieval-based диалогового бота.
- Инференса и валидации качества обученных моделей.
- Развёртывания решения в виде web-сервиса.

## 2. Используемые данные

- **Friends Scripts:** Датасет с репликами из сериала *«Друзья»* ([Kaggle: Friends Scripts](https://www.kaggle.com/datasets/amandam1/friends-scripts)).
- **Дополнительные сценарии:** Сценарии из таких источников, как [IMSDB](https://imsdb.com/all-scripts.html), включающие фильмы и сериалы (например, *«Звёздные войны»*, *«Кунг-фу панда»* и др.).

Диалоги формируются по следующей логике:
- **Контекст:** предыдущая реплика (вопрос).
- **Ответ:** реплика выбранного персонажа (Чендлер) для позитивного класса.
- Для негативного класса — случайный ответ из другой вселенной, что позволяет обучить модели различать корректные ответы и нерелевантные.

## 3. Предобработка данных

Скрипты для обработки данных включают:
- Разбиение данных на диалоговые пары.
- Формирование позитивных примеров (диалоги из сериала) и негативных примеров (контекст из сериала + случайный ответ из другой вселенной).

## 4. Обучение моделей

Для построения системы оценки релевантности ответов используются два подхода:

### 4.1 Bi-Encoder
- **Задача:** Обучение модели, которая независимо кодирует контекст и ответ.
- **Данные:** Позитивные пары из реплик сериала и негативные пары с случайным ответом.
- **Результаты:** Модель показала хорошую сходимость в обучении.

### 4.2 Cross-Encoder
- **Задача:** Обучение модели, которая совместно оценивает пару (контекст, ответ) для определения их релевантности.
- **Данные:** Пары с высокой связью (диалоги из сериала) и с низкой связью (контекст + случайный ответ).
- **Результаты:** Модель также продемонстрировала хорошую сходимость.

При выборе базовой модели опирались на рейтинги [MTEB](https://huggingface.co/spaces/mteb/leaderboard), что позволило использовать проверенные решения.

## 5. Инференс и развёртывание

### 5.1 Пробный инференс в ноутбуке
Прототип инференса был реализован с использованием [Gradio](https://gradio.app/), что позволило визуально оценить работу моделей.

### 5.2 Веб-сервис
- **Технологии:** Flask для создания API веб-сервиса, Docker-compose для контейнеризации, а также Qdrant для поиска с реранкингом.
- **Функциональность:** Возможность выбора персонажа и получение ответа, сгенерированного на основе выбора лучшей реплики.
  пример инференса доступен по [ссылке](http://45.114.61.171:5000)

## 6. Структура репозитория

hw1/   
├── config/ # Конфигурационные файлы для обучения и инференса    
├── data/    
│ ├── other/ # сценарии фильмов    
│ ├── friends.csv  # датасет реплик друзей   
│ ├── chandler.json # реплики Чандлера с контекстом   
│ ├── other.json # реплики Чандлера с контекстом  
│ └── dialogs.json # диалоги для Flask-инференса могут быть заменены на любые аналогичной структуры  
├── models/ # Сохранённые модели (Bi-Encoder, Cross-Encoder) доступны по ссылке   
├── notebooks/ # Jupyter-ноутбуки для экспериментов и инференса (Gradio demo)    
├── chatbot/   
│ ├── requirements.txt # Зависимости проекта   
│ ├── dockerfile # Конфигурация контейцнера Flask  
│ └── app.py # Flask приложение для веб-сервиса   
├── img/ # Графики и иллюстрации   
│ ├── gradio_demo.jpg # Пример диалога  
│ ├── chandler_flask_demo.jpg # пример диалога   
│ ├── ross_flask_demo.jpg # пример диалога    
│ ├── biencoder_learning.jpg # График сходимости Bi-Encoder   
│ └── crossencoder_learning.jpg# График сходимости Cross-Encoder    
├── docker-compose.yml # Файл для контейнеризации (Flask, Qdrant и т.д.)    
├── friends_retrival.ipynb # Ноутбук с кодом предобработки данных, обучением моделей и инференсом в gradio   
└── README.md # Отчёт (данный файл)   

## 7. Запуск проекта 

### Предварительные требования
- Docker 24.0+
- Docker Compose 2.20+
- NVIDIA GPU (рекомендуется)

### Инструкция:
```bash
# Клонировать репозиторий
git clone https://github.com/Niktyav/generate_nlp.git
cd generate_nlp/hw1

# Собрать контейнеры
docker-compose build

# Запустить контейнеры
docker-compose up -d 
